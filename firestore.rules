rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - users can only read/write their own data
    match /users/{uid}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    
    // Progress document validation
    match /users/{uid}/state/progress {
      allow read, write: if request.auth != null && request.auth.uid == uid
        && request.resource.data.keys().hasAll(['unlockedChapter', 'unlockedLevel', 'completed', 'stats'])
        && request.resource.data.unlockedChapter is int
        && request.resource.data.unlockedLevel is int
        && request.resource.data.completed is map;
    }
    
    // Current run document validation
    match /users/{uid}/state/currentRun {
      allow read, write: if request.auth != null && request.auth.uid == uid
        && request.resource.data.keys().hasAll(['chapter', 'level', 'gridSize', 'currentGrid'])
        && request.resource.data.chapter is int
        && request.resource.data.level is int
        && request.resource.data.gridSize is int
        && request.resource.data.currentGrid is list;
    }
    
    // Settings document validation
    match /users/{uid}/game/settings {
      allow read, write: if request.auth != null && request.auth.uid == uid
        && request.resource.data.keys().hasAll(['language', 'sound', 'haptic', 'autoCheck']);
    }
  }
}
